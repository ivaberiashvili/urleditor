<!DOCTYPE html>
<html>
<head>
  <title>URL Editor with Matching Wrap</title>
  
  <!-- CodeMirror CSS from CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css" />
  <!-- Diff Match Patch Library from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  
  <style>
    /* Universal settings: Montserrat (or fallback to arial/sans-serif) and line-height: 1.5 */
    body {
      font-family: Montserrat, arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      padding: 20px;
      background-color: #f0f0f0;
      max-width: 1280px;
      margin: 0 auto;
    }
    
    /* Fixed-width container in ch units to align line wrapping */
    .column {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 80ch; /* Adjust if needed */
      box-sizing: border-box;
    }
    
    h2 {
      margin-top: 0;
      color: #333;
    }
    
    label {
      font-size: 0.9em;
      margin-bottom: 6px;
      display: inline-block;
    }
    
    /* Input textarea styles */
    textarea {
      display: block;
      width: 100%;
      height: 240px;
      margin-bottom: 20px;
      box-sizing: border-box;
      
      /* Ensure identical wrapping */
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow-x: hidden;
      overflow-y: auto;
      
      /* Use universal font styles */
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    
    /* Output div styles */
    .output {
      width: 100%;
      height: 240px;
      overflow-y: auto;
      
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      box-sizing: border-box;
      
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      padding: 8px;
    }
    
    .matchMessage {
      font-size: 0.9em;
      font-weight: bold;
      margin-top: 5px;
      line-height: 1.4;
      min-height: 18px;
    }
    
    /* CodeMirror instance styling */
    .CodeMirror {
      box-sizing: border-box;
      width: 100%;
      height: 240px;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
    }
    
    .CodeMirror-scroll {
      overflow-x: hidden;
    }
    
    /* Custom CodeMirror highlighting classes */
    .cm-appsflyer-id { color: #4CAF50; }
    .cm-query-key    { color: #ff477e; }
    .cm-query-value  { color: #5465ff; }
    /* Operator styling: */
    .cm-operator     { color: #ff477e; } 
    .cm-punctuation  { color: #212121; }
    
    /* Highlight diff changes in the CodeMirror editor */
    .diff-highlight { background-color: yellow; }
  </style>
</head>
<body>
  <h1>URL Editor</h1>

  <div class="column">
    <h2 id="sectionTitle">Clicks</h2>
    
    <!-- Original Input -->
    <label for="clicksInput">Input</label>
    <textarea id="clicksInput" spellcheck="false" placeholder="Paste URL here..."></textarea>
    
    <!-- Colorized Output (for reference only) -->
    <label for="clicksOutput">Output</label>
    <div id="clicksOutput" class="output"></div>
    <div id="clicksMessage" class="matchMessage"></div>
  </div>
  
  <div class="column">
    <!-- Editable Text Area using CodeMirror -->
    <label for="clicksEditor">Edit URL</label>
    <textarea id="clicksEditor" spellcheck="false" placeholder="Adjust the URL here..."></textarea>
  </div>
  
  <!-- CodeMirror JS from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
  
  <!-- Define a custom CodeMirror mode ("urlmode") -->
  <script>
    CodeMirror.defineMode("urlmode", function(config, parserConfig) {
      return {
        startState: function() {
          return {
            inQuery: false,
            paramPhase: null,
            isAppsflyer: false
          };
        },
        token: function(stream, state) {
          if (!state.isAppsflyer) {
            if (stream.string.indexOf("appsflyer") !== -1) {
              state.isAppsflyer = true;
            }
          }
          if (!state.inQuery) {
            if (stream.peek() === "?") {
              stream.next();
              state.inQuery = true;
              state.paramPhase = "key";
              return "punctuation";
            }
            if (state.isAppsflyer && stream.match(/id\d+/, true)) {
              return "appsflyer-id";
            }
            stream.next();
            return null;
          } else {
            if (stream.peek() === "&") {
              stream.next();
              state.paramPhase = "key";
              return "punctuation";
            }
            if (state.paramPhase === "key") {
              if (stream.match(/[^=&]+/, true)) {
                if (stream.peek() === "=") {
                  state.paramPhase = "operator";
                }
                return "query-key";
              }
            }
            if (state.paramPhase === "operator") {
              if (stream.match("=", true)) {
                state.paramPhase = "value";
                return "operator";
              }
            }
            if (state.paramPhase === "value") {
              if (stream.match(/[^&]+/, true)) {
                return "query-value";
              }
            }
            stream.next();
            return null;
          }
        }
      };
    });
  </script>
  
  <script>
    // Utility function for escaping HTML (used in Output)
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    
    // Function to colorize URL for the reference Output (HTML version)
    function colorizeString(rawUrl) {
      const questionIndex = rawUrl.indexOf("?");
      if (questionIndex === -1) {
        return escapeHtml(rawUrl);
      }
      
      const baseUrl = rawUrl.slice(0, questionIndex + 1);
      const query = rawUrl.slice(questionIndex + 1);
      
      let escapedBase = escapeHtml(baseUrl);
      if (rawUrl.includes("appsflyer")) {
        escapedBase = escapedBase.replace(/(id\d+)/, `<span style="color: #4CAF50;">$1</span>`);
      }
      
      const params = query.split("&");
      const coloredParams = params.map(param => {
        if (param.includes("=")) {
          const [key, ...valParts] = param.split("=");
          const value = valParts.join("=");
          return `<span style="color: #ff477e;">${escapeHtml(key)}=</span><span style="color: #5465ff;">${escapeHtml(value)}</span>`;
        } else {
          return `<span style="color: red;">${escapeHtml(param)}</span>`;
        }
      });
      
      return escapedBase + coloredParams.join(`<span style="color: black;">&amp;</span>`);
    }
    
    function checkUrlMatch(original, outputDiv, messageElement) {
      const outputText = outputDiv.textContent;
      if (original === outputText) {
        messageElement.textContent = "URLs match";
        messageElement.style.color = "green";
      } else {
        messageElement.textContent = "URLs mismatch";
        messageElement.style.color = "red";
      }
    }
    
    // Grab DOM elements
    const clicksInput   = document.getElementById("clicksInput");
    const clicksOutput  = document.getElementById("clicksOutput");
    const clicksMessage = document.getElementById("clicksMessage");
    const sectionTitle  = document.getElementById("sectionTitle");
    
    let originalInputValue = "";
    
    // Instantiate CodeMirror on the hidden textarea for the Edit URL window.
    const editor = CodeMirror.fromTextArea(document.getElementById("clicksEditor"), {
      lineNumbers: false,
      mode: "urlmode",
      lineWrapping: true
    });
    
    // When the user pastes or types in the Input area:
    clicksInput.addEventListener("input", function () {
      originalInputValue = this.value.trim();
      updateOutput(originalInputValue);
      // Update CodeMirror with the same text
      editor.setValue(originalInputValue);
    });
    
    // Function to update Output and the heading based on the URL from Input
    function updateOutput(url) {
      if (url.includes("appsflyer")) {
        if (url.includes("impression")) {
          sectionTitle.textContent = "Impressions";
        } else if (url.includes("app")) {
          sectionTitle.textContent = "Clicks";
        }
      } else if (url.includes("imp")) {
        sectionTitle.textContent = "Impressions";
      } else {
        sectionTitle.textContent = "Clicks";
      }
      clicksOutput.innerHTML = colorizeString(url);
      checkUrlMatch(originalInputValue, clicksOutput, clicksMessage);
    }
    
    // Highlight differences in the CodeMirror editor.
    // Whenever the CodeMirror editor content changes, compute a diff versus originalInputValue.
    // Any inserted text is marked with the "diff-highlight" class.
    editor.on("change", function(cm, change) {
      // Clear previous markers
      if (window.diffMarkers) {
        window.diffMarkers.forEach(function(marker) { marker.clear(); });
      }
      window.diffMarkers = [];
      
      const newValue = cm.getValue();
      const dmp = new diff_match_patch();
      const diffs = dmp.diff_main(originalInputValue, newValue);
      dmp.diff_cleanupSemantic(diffs);
      
      let pos = 0;
      diffs.forEach(function(diff) {
        const op = diff[0], text = diff[1];
        if (op === 0) { // No change
          pos += text.length;
        } else if (op === 1) { // Insertion: mark these characters
          const startPos = cm.posFromIndex(pos);
          const endPos = cm.posFromIndex(pos + text.length);
          window.diffMarkers.push(cm.markText(startPos, endPos, { className: "diff-highlight" }));
          pos += text.length;
        }
        // Note: Deletions (op === -1) do not appear in the new text.
      });
    });
  </script>
</body>
</html>